# スナップショット管理

Nvecd はサーバー状態をバックアップ・復元するためのスナップショットコマンドを提供します。スナップショットには、イベントストア、ベクトルストア、共起インデックスを含むすべてのデータが含まれます。

## 概要

スナップショットは単一のバイナリファイル（`.nvec`）で、以下を含みます：
- 完全なイベントストアデータ（コンテキスト、イベント、リングバッファ）
- ベクトルストアデータ（すべての登録済みベクトル）
- 共起インデックス（関係スコア）
- 整合性チェックサム（CRC32）による破損検出

## コマンド

### DUMP SAVE - スナップショット作成

現在のサーバー状態をスナップショットファイルに保存します。

**構文:**
```
DUMP SAVE [filepath]
```

**パラメータ:**
- `[filepath]` (オプション): スナップショットファイルの保存先パス。省略すると、タイムスタンプ付きファイル名が自動生成されます。

**例:**
```
-- 手動スナップショット
DUMP SAVE /var/lib/nvecd/snapshots/backup.nvec

-- 自動生成ファイル名
DUMP SAVE
```

**レスポンス:**
```
OK Snapshot saved: /var/lib/nvecd/snapshots/backup.nvec
event_store_contexts: 100
vector_store_vectors: 2000
co_occurrence_pairs: 1500
size: 1048576 bytes
```

**自動生成ファイル名形式**: `dump_YYYYMMDD_HHMMSS.nvec`

---

### DUMP LOAD - スナップショット復元

スナップショットファイルを読み込み、サーバー状態を復元します。

**構文:**
```
DUMP LOAD <filepath>
```

**パラメータ:**
- `<filepath>`: 読み込むスナップショットファイルのパス

**例:**
```
DUMP LOAD /var/lib/nvecd/snapshots/backup.nvec
```

**レスポンス:**
```
OK Snapshot loaded: 5000 events, 2000 vectors
event_store_contexts: 100
vector_store_vectors: 2000
co_occurrence_pairs: 1500
```

**重要な注意事項:**
- スナップショットの読み込みは現在のすべてのデータを**置き換えます**
- 読み込み中、サーバーは読み取り専用モードになります
- 既存の接続はすべて読み込み中にエラーを受け取ります

---

### DUMP VERIFY - 整合性チェック

スナップショットファイルの整合性を、読み込まずに検証します。

**構文:**
```
DUMP VERIFY <filepath>
```

**パラメータ:**
- `<filepath>`: 検証するスナップショットファイルのパス

**例:**
```
DUMP VERIFY /var/lib/nvecd/snapshots/backup.nvec
```

**レスポンス（成功）:**
```
OK Snapshot is valid (CRC32: 0x12345678)
status: valid
crc: verified
size: verified
```

**レスポンス（失敗）:**
```
(error) CRC mismatch: file may be corrupted
expected: 0x12345678
actual: 0x87654321
```

---

### DUMP INFO - スナップショットメタデータ表示

スナップショットファイルのメタデータを、読み込まずに表示します。

**構文:**
```
DUMP INFO <filepath>
```

**パラメータ:**
- `<filepath>`: スナップショットファイルのパス

**例:**
```
DUMP INFO /var/lib/nvecd/snapshots/backup.nvec
```

**レスポンス:**
```
OK INFO
version: 1
event_store_count: 5000
vector_store_count: 2000
co_occurrence_count: 1500
file_size: 1048576
created_at: 2025-01-18T12:00:00
```

---

## 整合性保護

### CRC32 チェックサム

すべてのスナップショットファイルには CRC32 チェックサムが含まれます：
- **ファイルレベル CRC**: ファイル全体の破損を検出
- **セクションレベル CRC**: 個別セクション（イベントストア、ベクトルストア、共起インデックス）を検証

### ファイルサイズ検証

スナップショットヘッダーには予想ファイルサイズが含まれます：
- 不完全な書き込みを検出
- ネットワーク転送の失敗を検出
- 切り詰められたファイルを識別

---

## スナップショット形式

### バージョン 1 形式

現在のスナップショット形式（バージョン 1）：

```
┌─────────────────────────────────────┐
│ ヘッダー (40 バイト)                │
│  - マジックナンバー (4 バイト)      │
│  - バージョン (4 バイト)            │
│  - フラグ (4 バイト)                │
│  - ストア数 (12 バイト)             │
│  - タイムスタンプ (16 バイト)       │
├─────────────────────────────────────┤
│ イベントストアデータ                │
│  - コンテキスト                     │
│  - リングバッファ                   │
│  - イベントデータ                   │
├─────────────────────────────────────┤
│ 共起インデックスデータ              │
│  - ID ペア                          │
│  - スコア                           │
├─────────────────────────────────────┤
│ ベクトルストアデータ                │
│  - ID マッピング                    │
│  - 次元情報                         │
│  - ベクトルデータ                   │
├─────────────────────────────────────┤
│ フッター (8 バイト)                 │
│  - ファイル CRC32 (4 バイト)        │
│  - 予約 (4 バイト)                  │
└─────────────────────────────────────┘
```

---

## 自動スナップショット

### 設定

`config.yaml` で自動スナップショットを有効化：

```yaml
snapshot:
  dir: "/var/lib/nvecd/snapshots"
  interval_sec: 7200           # 2時間
  retain: 5                    # 5個のスナップショットを保持
```

### 自動スナップショットの動作

- スケジュールに従って自動的にスナップショットを作成
- ファイル名: `auto_YYYYMMDD_HHMMSS.snapshot`
- 古いスナップショットは自動的にクリーンアップ（最新の `retain` 個を保持）
- 手動スナップショットはクリーンアップの**影響を受けません**

---

## ベストプラクティス

### バックアップ戦略

1. **定期的な自動スナップショット**
   - `interval_sec` を RPO（目標復旧時点）に合わせて設定
   - 一般的な値: 3600 (1時間), 7200 (2時間), 14400 (4時間)

2. **重要な操作前の手動スナップショット**
   ```
   DUMP SAVE /backup/before_upgrade.nvec
   ```

3. **定期的なスナップショット検証**
   ```
   DUMP VERIFY /var/lib/nvecd/snapshots/auto_20250118_120000.snapshot
   ```

### ストレージ推奨事項

- `snapshot.dir` 用に専用のバックアップボリュームを使用
- ディスク容量を監視（スナップショットは大きくなる可能性があります）
- 災害復旧のためのオフサイトバックアップを検討
- 長期保存にはファイル圧縮を使用

### リカバリーテスト

定期的にスナップショット復元をテスト：

```bash
# 本番サーバーを停止
systemctl stop nvecd

# テストサーバーで読み込みテスト
nvecd-test -c config.yaml
> DUMP LOAD /backup/snapshot.nvec
> INFO
> (データ整合性を確認)
```

---

## セキュリティ上の考慮事項

### ファイルパーミッション

スナップショットファイルには機密データが含まれる可能性があります。適切なパーミッションで保護してください：

```bash
# 推奨パーミッション
chmod 600 /var/lib/nvecd/snapshots/*.nvec
chown nvecd:nvecd /var/lib/nvecd/snapshots/*.nvec
```

### パストラバーサル保護

Nvecd はパストラバーサル攻撃を防止します：
- `..` を含むパスを拒否
- 設定された `snapshot.dir` 内のパスを検証
- ホワイトリストされたディレクトリからの保存/読み込みのみ許可

---

## トラブルシューティング

### スナップショット保存失敗

**エラー**: `(error) Cannot save snapshot: read-only mode`
- **原因**: サーバーが読み取り専用モード（読み込み中）
- **解決方法**: 読み込み完了を待つ

**エラー**: `(error) Permission denied`
- **原因**: `snapshot.dir` への書き込み権限がない
- **解決方法**: ディレクトリのパーミッションと所有権を確認

### スナップショット読み込み失敗

**エラー**: `(error) CRC mismatch: file may be corrupted`
- **原因**: ファイル破損または不完全な書き込み
- **解決方法**: 別のスナップショットファイルを使用

**エラー**: `(error) Version mismatch: expected 1, got 2`
- **原因**: より新しい Nvecd バージョンで作成されたスナップショット
- **解決方法**: 互換性のあるバージョンに Nvecd をアップグレード

---

## 次のステップ

- スナップショット設定については [設定ガイド](configuration.md) を参照
- DUMP コマンド構文については [プロトコルリファレンス](protocol.md) を参照
- デプロイ手順については [インストールガイド](installation.md) を参照
